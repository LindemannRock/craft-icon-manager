"undefined"==typeof IconManager&&(window.IconManager={}),IconManager.IconPicker=function(e,t){this.fieldId=e,this.settings=t||{},this.icons=[],this.showSearch=!1!==t.showSearch,this.showLabels=!1!==t.showLabels,this.iconSize=t.iconSize||"medium",this.iconsPerPage=t.iconsPerPage||100,this.allowMultiple=!0===t.allowMultiple,this.selectedIcons=[],this.iconsLoaded=!1,this.iconsLoading=!1,this.virtualScrollBatchSize=50,this.virtualScrollRenderedIcons={},this.virtualScrollObservers={},this.init()},IconManager.IconPicker.prototype={init:function(){this.$field=document.getElementById(this.fieldId),this.$field&&(this.$input=this.$field.querySelector('input[type="hidden"]'),this.$selectBtn=this.$field.querySelector(".icon-manager-select-btn"),this.$clearBtn=this.$field.querySelector(".icon-manager-clear-btn"),this.$picker=this.$field.querySelector(".icon-manager-picker"),this.$cancelBtn=this.$picker.querySelector(".icon-manager-cancel-btn"),this.$customLabelInput=this.$field.querySelector(".icon-manager-custom-label-input"),this.bindEvents())},bindEvents:function(){var e=this;this.currentValue=this.getCurrentValue(),this.allowMultiple&&(this.selectedIcons=Array.isArray(this.currentValue)?this.currentValue.slice():[]),this.bindCustomLabelInputs(),this.$selectBtn&&this.$selectBtn.addEventListener("click",function(t){t.preventDefault(),e.togglePicker()}),this.$clearBtn&&this.$clearBtn.addEventListener("click",function(t){t.preventDefault(),e.clearSelection()}),this.$cancelBtn&&this.$cancelBtn.addEventListener("click",function(t){t.preventDefault(),e.cancelSelection()});var t=this.$field.querySelector(".icon-manager-done-btn");t&&t.addEventListener("click",function(t){t.preventDefault(),e.hidePicker()});var n=this.$picker.querySelector(".icon-manager-search-input");n&&(n.addEventListener("input",function(t){e.filterIcons(t.target.value)}),n.addEventListener("click",function(e){e.stopPropagation()}),n.addEventListener("keyup",function(t){"Escape"===t.key&&(n.value="",e.filterIcons(""))})),this.$picker.querySelectorAll(".tab").forEach(function(t){t.addEventListener("click",function(n){n.preventDefault(),e.switchTab(t.dataset.iconSet)})});var i=this.$picker.querySelector(".icon-manager-tab-select");i&&i.addEventListener("change",function(t){e.switchTab(t.target.value),e.updateDropdownCount(t.target.value)}),document.addEventListener("click",function(t){e.$field.contains(t.target)||e.hidePicker()})},showPicker:function(){this.$picker.classList.remove("hidden"),this.savedValue=this.getCurrentValue(),this.allowMultiple&&(this.savedSelectedIcons=this.selectedIcons.slice()),this.iconsLoaded||this.iconsLoading?this.showIconsInPicker():this.fetchIconsForField()},showIconsInPicker:function(){this.hideEmptyIconSets();var e=this.getCurrentValue(),t=null;if(this.allowMultiple&&this.selectedIcons.length>0?t=this.selectedIcons[0].iconSetHandle:e&&e.iconSetHandle&&(t=e.iconSetHandle),t)this.switchTab(t),this.updateDropdownCount(t);else{var n=this.$picker.querySelector(".icon-manager-tab-select");if(n&&n.value)this.updateDropdownCount(n.value);else{var i=this.findFirstNonEmptyIconSet();i&&this.switchTab(i)}}this.loadIcons(),this.updateIconCounts()},fetchIconsForField:function(){var e=this;this.iconsLoading=!0;var t=this.$picker.querySelectorAll(".icon-manager-grid");t.forEach(function(e){var t=e.querySelector(".icon-manager-grid-inner");t&&(t.innerHTML='<div class="icon-manager-loading">Loading icons...</div>')}),fetch(Craft.getCpUrl("icon-manager/icons/get-icons-for-field"),{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-Token":Craft.csrfTokenValue,Accept:"application/json"},body:JSON.stringify({fieldId:this.settings.fieldId})}).then(function(e){return e.json()}).then(function(t){t.success&&t.icons?(e.icons=t.icons,e.iconsLoaded=!0,e.iconsLoading=!1,e.showIconsInPicker()):(console.error("Failed to load icons:",t.error||"Unknown error"),e.iconsLoading=!1)}).catch(function(n){console.error("Failed to load icons:",n),e.iconsLoading=!1,t.forEach(function(e){var t=e.querySelector(".icon-manager-grid-inner");t&&(t.innerHTML='<div class="icon-manager-error">Failed to load icons. Please try again.</div>')})})},hidePicker:function(){this.$picker.classList.add("hidden")},togglePicker:function(){this.$picker.classList.contains("hidden")?this.showPicker():this.hidePicker()},loadIcons:function(e){var t=this,n=this.$picker.querySelectorAll(".icon-manager-grid");if(e&&n.forEach(function(e){var n=e.dataset.iconSet;t.icons.some(function(e){return e.iconSetHandle===n})&&e.classList.remove("hidden")}),n.forEach(function(n){var i=n.querySelector(".icon-manager-grid-inner");if(i){var c=n.dataset.iconSet;if(t.icons.some(function(e){return e.iconSetHandle===c})){i.innerHTML="";var a=t.icons.filter(function(t){if(t.iconSetHandle!==c)return!1;if(e){var n=e.toLowerCase(),i=t.name.toLowerCase().includes(n),a=t.label&&t.label.toLowerCase().includes(n),r=t.keywords&&Array.isArray(t.keywords)&&t.keywords.some(function(e){return e&&e.toLowerCase&&e.toLowerCase().includes(n)});return i||a||r}return!0});if(n.dataset.iconsToShow=JSON.stringify(a),t.virtualScrollRenderedIcons[c]=0,t.renderIconBatch(i,a,c,t.virtualScrollBatchSize),a.length>t.virtualScrollBatchSize&&t.setupVirtualScrollObserver(i,a,c),0===a.length)if(e)n.style.display="none";else if(t.icons.some(function(e){return e.iconSetHandle===c}))i.innerHTML='<div class="icon-manager-empty">'+Craft.t("icon-manager","No icons found")+"</div>";else{n.style.display="none";var r=t.$picker.querySelector('.tab[data-icon-set="'+c+'"]');r&&r.parentNode&&(r.parentNode.style.display="none")}else n.style.display=""}else n.style.display="none"}}),e){var i=!1,c=null;n.forEach(function(e){var n=e.dataset.iconSet;t.icons.some(function(e){return e.iconSetHandle===n})&&"none"!==e.style.display&&(i=!0,c||(c=e))}),!i&&c&&(c.style.display="",c.querySelector(".icon-manager-grid-inner").innerHTML='<div class="icon-manager-empty">'+Craft.t("icon-manager","No icons match your search")+"</div>")}},filterIcons:function(e){if(e)this.$picker.classList.add("searching");else{this.$picker.classList.remove("searching");var t=this.$picker.querySelector(".tab.sel"),n=this.$picker.querySelector(".icon-manager-tab-select");t?this.switchTab(t.dataset.iconSet):n&&this.switchTab(n.value)}this.loadIcons(e),this.updateIconCounts(e)},switchTab:function(e){this.$picker.querySelectorAll(".tab").forEach(function(t){t.dataset.iconSet===e?t.classList.add("sel"):t.classList.remove("sel")});var t=this.$picker.querySelector(".icon-manager-tab-select");t&&t.value!==e&&(t.value=e),this.$picker.querySelectorAll(".icon-manager-grid").forEach(function(t){t.dataset.iconSet===e?t.classList.remove("hidden"):t.classList.add("hidden")})},selectIcon:function(e){if(this.allowMultiple){e.iconSetHandle,e.name;var t=this.selectedIcons.findIndex(function(t){return t.iconSetHandle===e.iconSetHandle&&t.name===e.name});t>-1?this.selectedIcons.splice(t,1):this.selectedIcons.push({iconSetHandle:e.iconSetHandle,name:e.name,type:e.type,value:e.value}),this.$input.value=JSON.stringify(this.selectedIcons),this.currentValue=this.selectedIcons,this.updateMultipleDisplay(),this.updateIconSelectionStates()}else{this.currentValue={iconSetHandle:e.iconSetHandle,name:e.name,type:e.type,value:e.value},this.$input.value=JSON.stringify(this.currentValue);var n=this.$field.querySelector(".icon-manager-selected"),i=n.querySelector(".icon-manager-placeholder"),c=n.querySelector(".icon-manager-selected-icon");if(i){var a=48;"small"===this.iconSize?a=32:"large"===this.iconSize&&(a=64);var r='<div class="icon-manager-selected-icon">';if(e.content){var o=document.createElement("div");o.innerHTML=e.content;var s=o.querySelector("svg"),l=o.querySelector("i");s?(s.setAttribute("width",a),s.setAttribute("height",a),r+=o.innerHTML):l&&e.isFontAwesome?(l.style.fontSize=a/24+"rem",r+=o.innerHTML):r+=e.content}else r+='<svg width="'+a+'" height="'+a+'" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><text x="12" y="16" text-anchor="middle">'+e.name.charAt(0).toUpperCase()+"</text></svg>";this.showLabels&&(r+='<div class="icon-manager-selected-label">'+(e.label||e.name)+"</div>"),r+="</div>",i.outerHTML=r}else c&&this.displayIcon(e,n,c,null);if(!this.$clearBtn){var d=n.querySelector(".icon-manager-actions"),u=document.createElement("button");u.type="button",u.className="btn icon-manager-clear-btn",u.textContent=Craft.t("icon-manager","Clear"),d.appendChild(u);var h=this;u.addEventListener("click",function(e){e.preventDefault(),h.clearSelection()}),this.$clearBtn=u}this.$selectBtn.textContent=Craft.t("icon-manager","Edit Selection"),this.updateIconSelectionStates()}},clearSelection:function(){if(this.allowMultiple)this.selectedIcons=[],this.currentValue=[],this.$input.value=JSON.stringify([]),this.updateMultipleDisplay();else{this.currentValue=null,this.$input.value="";var e=this.$field.querySelector(".icon-manager-selected").querySelector(".icon-manager-selected-icon");if(e){var t='<div class="icon-manager-placeholder">';t+='<svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">',t+='<rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>',t+='<line x1="9" y1="9" x2="15" y2="15"></line>',t+='<line x1="15" y1="9" x2="9" y2="15"></line>',t+="</svg>",t+='<div class="icon-manager-placeholder-text">'+Craft.t("icon-manager","No icon selected")+"</div>",t+="</div>",e.outerHTML=t}this.$selectBtn.textContent=Craft.t("icon-manager","Select Icons")}this.$clearBtn&&(this.$clearBtn.remove(),this.$clearBtn=null),this.$picker&&!this.$picker.classList.contains("hidden")&&this.updateIconSelectionStates()},updateMultipleDisplay:function(){var e=this,t=this.$field.querySelector(".icon-manager-selected"),n=48;"small"===this.iconSize?n=32:"large"===this.iconSize&&(n=64);var i=t.querySelector(".icon-manager-selected-icons-grid"),c=t.querySelector(".icon-manager-placeholder");if(i&&i.remove(),c&&c.remove(),0===this.selectedIcons.length){var a='<div class="icon-manager-placeholder">';a+='<svg width="'+n+'" height="'+n+'" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">',a+='<rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>',a+='<line x1="9" y1="9" x2="15" y2="15"></line>',a+='<line x1="15" y1="9" x2="9" y2="15"></line>',a+="</svg>",a+='<div class="icon-manager-placeholder-text">'+Craft.t("icon-manager","No icons selected")+"</div>",a+="</div>",(r=t.querySelector(".icon-manager-actions")).insertAdjacentHTML("beforebegin",a),this.$selectBtn.textContent=Craft.t("icon-manager","Select Icons")}else{var r,o='<div class="icon-manager-selected-icons-grid">';if(this.selectedIcons.forEach(function(t){o+='<div class="icon-manager-selected-icon">';var i=e.icons.find(function(e){return e.iconSetHandle===t.iconSetHandle&&e.name===t.name});if(i&&i.content){var c=document.createElement("div");c.innerHTML=i.content;var a=c.querySelector("svg");a&&(a.setAttribute("width",n),a.setAttribute("height",n)),o+=c.innerHTML}else o+='<svg width="'+n+'" height="'+n+'" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><text x="12" y="16" text-anchor="middle">'+t.name.charAt(0).toUpperCase()+"</text></svg>";e.showLabels&&(o+='<div class="icon-manager-selected-label">'+(i?i.label||i.name:t.name)+"</div>"),o+="</div>"}),o+="</div>",(r=t.querySelector(".icon-manager-actions")).insertAdjacentHTML("beforebegin",o),this.$selectBtn.textContent=Craft.t("icon-manager","Edit Selection"),!this.$clearBtn){var s=document.createElement("button");s.type="button",s.className="btn icon-manager-clear-btn",s.textContent=Craft.t("icon-manager","Clear"),r.appendChild(s),s.addEventListener("click",function(t){t.preventDefault(),e.clearSelection()}),this.$clearBtn=s}}this.bindCustomLabelInputs()},updateIconSelectionStates:function(){var e=this;this.$picker.querySelectorAll(".icon-manager-grid-item").forEach(function(t){var n=JSON.parse(t.dataset.iconData);(e.allowMultiple?e.selectedIcons.some(function(e){return e.iconSetHandle===n.iconSetHandle&&e.name===n.name}):e.currentValue&&e.currentValue.iconSetHandle===n.iconSetHandle&&e.currentValue.name===n.name)?t.classList.add("selected"):t.classList.remove("selected")})},getCurrentValue:function(){if(this.$input.value)try{return JSON.parse(this.$input.value)}catch(e){return null}return null},updateIconCounts:function(e){var t={};this.icons.forEach(function(n){if(t[n.iconSetHandle]||(t[n.iconSetHandle]=0),e){var i=e.toLowerCase(),c=n.name.toLowerCase().includes(i),a=n.label&&n.label.toLowerCase().includes(i),r=n.keywords&&Array.isArray(n.keywords)&&n.keywords.some(function(e){return e&&e.toLowerCase&&e.toLowerCase().includes(i)});(c||a||r)&&t[n.iconSetHandle]++}else t[n.iconSetHandle]++}),this.$picker.querySelectorAll(".icon-count").forEach(function(e){var n=e.dataset.iconSet,i=t[n]||0;e.textContent="("+i+")"});var n=this.$picker.querySelector(".icon-count-dropdown");if(n){var i=n.dataset.iconSet,c=t[i]||0;n.textContent="("+c+" icons)"}if(e){var a=this.$picker.querySelector(".tab.sel");if((i=a?a.dataset.iconSet:null)&&0===t[i])for(var r in t)if(t[r]>0){this.switchTab(r);break}}},updateDropdownCount:function(e){var t=this.$picker.querySelector(".icon-count-dropdown");if(t){t.dataset.iconSet=e;var n=0;this.icons.forEach(function(t){t.iconSetHandle===e&&n++}),t.textContent="("+n+" icons)"}},hideEmptyIconSets:function(){var e={};this.icons.forEach(function(t){e[t.iconSetHandle]||(e[t.iconSetHandle]=0),e[t.iconSetHandle]++}),this.$picker.querySelectorAll(".tab").forEach(function(t){var n=t.dataset.iconSet;e[n]&&0!==e[n]?t.parentNode.style.display="":t.parentNode.style.display="none"});var t=this.$picker.querySelector(".icon-manager-tab-select");t&&t.querySelectorAll("option").forEach(function(t){var n=t.value;e[n]&&0!==e[n]?(t.style.display="",t.disabled=!1):(t.style.display="none",t.disabled=!0)})},findFirstNonEmptyIconSet:function(){var e={};for(var t in this.icons.forEach(function(t){e[t.iconSetHandle]||(e[t.iconSetHandle]=0),e[t.iconSetHandle]++}),e)if(e[t]>0)return t;return null},cancelSelection:function(){this.allowMultiple?(this.selectedIcons=this.savedSelectedIcons?this.savedSelectedIcons.slice():[],this.currentValue=this.selectedIcons,this.$input.value=JSON.stringify(this.selectedIcons),this.updateMultipleDisplay()):(this.savedValue?(this.currentValue=this.savedValue,this.$input.value=JSON.stringify(this.savedValue)):(this.currentValue=null,this.$input.value=""),this.updateDisplay()),this.hidePicker()},updateDisplay:function(){var e=this,t=this.$field.querySelector(".icon-manager-selected"),n=t.querySelector(".icon-manager-selected-icon"),i=t.querySelector(".icon-manager-placeholder"),c=t.querySelector(".icon-manager-actions");if(this.currentValue){var a=this.icons.find(function(t){return t.iconSetHandle===e.currentValue.iconSetHandle&&t.name===e.currentValue.name});a?this.displayIcon(a,t,n,i):fetch(Craft.getCpUrl("icon-manager/icons/get-data"),{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-Token":Craft.csrfTokenValue,Accept:"application/json"},body:JSON.stringify({iconSet:this.currentValue.iconSetHandle,icon:this.currentValue.name})}).then(function(e){return e.json()}).then(function(c){c.success&&c.icon&&e.displayIcon(c.icon,t,n,i)}).catch(function(e){console.error("Failed to load icon:",e)});var r=c.querySelector(".icon-manager-clear-btn");if(r)this.$clearBtn=r;else{var o=document.createElement("button");o.type="button",o.className="btn icon-manager-clear-btn",o.textContent=Craft.t("icon-manager","Clear"),c.appendChild(o),o.addEventListener("click",function(t){t.preventDefault(),e.clearSelection()}),this.$clearBtn=o}this.$selectBtn.textContent=Craft.t("icon-manager","Edit Selection")}else{if(n){var s='<div class="icon-manager-placeholder">';s+='<svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">',s+='<rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>',s+='<line x1="9" y1="9" x2="15" y2="15"></line>',s+='<line x1="15" y1="9" x2="9" y2="15"></line>',s+="</svg>",s+='<div class="icon-manager-placeholder-text">'+Craft.t("icon-manager","No icon selected")+"</div>",s+="</div>",n.outerHTML=s}this.$clearBtn&&(this.$clearBtn.remove(),this.$clearBtn=null),this.$selectBtn.textContent=Craft.t("icon-manager","Select Icons")}},bindCustomLabelInputs:function(){var e=this,t=this.$field.querySelector(".icon-manager-custom-label-input");t&&!this.allowMultiple&&t.addEventListener("input",function(t){e.updateSingleCustomLabel(t.target.value)}),this.$field.querySelectorAll("[data-icon-index]").forEach(function(t){var n=parseInt(t.dataset.iconIndex);e.selectedIcons&&e.selectedIcons[n]&&t.value&&(e.selectedIcons[n].hasOwnProperty("customLabel")||(e.selectedIcons[n].customLabel=t.value)),t.addEventListener("input",function(t){e.updateMultipleCustomLabel(n,t.target.value)})})},updateSingleCustomLabel:function(e){this.currentValue&&(this.currentValue.customLabel=e,this.$input.value=JSON.stringify(this.currentValue))},updateMultipleCustomLabel:function(e,t){this.allowMultiple&&this.selectedIcons&&this.selectedIcons[e]&&(this.selectedIcons[e].customLabel=t,this.currentValue=this.selectedIcons,this.$input.value=JSON.stringify(this.selectedIcons))},displayIcon:function(e,t,n,i){var c=48;"small"===this.iconSize?c=32:"large"===this.iconSize&&(c=64);var a='<div class="icon-manager-selected-icon">';if(e.content){var r=document.createElement("div");r.innerHTML=e.content;var o=r.querySelector("svg");o&&(o.setAttribute("width",c),o.setAttribute("height",c)),a+=r.innerHTML}else a+='<svg width="'+c+'" height="'+c+'" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><text x="12" y="16" text-anchor="middle">'+e.name.charAt(0).toUpperCase()+"</text></svg>";this.showLabels&&(a+='<div class="icon-manager-selected-label">'+(e.label||e.name)+"</div>"),a+="</div>",i?i.outerHTML=a:n&&(n.outerHTML=a)},renderIconBatch:function(e,t,n,i){for(var c=this.virtualScrollRenderedIcons[n]||0,a=Math.min(c+i,t.length),r=c;r<a;r++){var o=t[r],s=this.createIconElement(o);e.appendChild(s)}return this.virtualScrollRenderedIcons[n]=a,a<t.length},createIconElement:function(e){var t=this,n=document.createElement("div");n.className="icon-manager-grid-item",(this.allowMultiple?this.selectedIcons.some(function(t){return t.iconSetHandle===e.iconSetHandle&&t.name===e.name}):this.currentValue&&this.currentValue.iconSetHandle===e.iconSetHandle&&this.currentValue.name===e.name)&&(n.className+=" selected"),n.dataset.iconData=JSON.stringify(e);var i=document.createElement("div");if(i.className="icon-manager-grid-item-icon",e.content?i.innerHTML=e.content:i.innerHTML='<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><text x="12" y="16" text-anchor="middle" font-size="10">'+e.name.charAt(0).toUpperCase()+"</text></svg>",n.appendChild(i),this.showLabels){var c=document.createElement("div");c.className="icon-manager-grid-item-label",c.textContent=e.label||e.name,n.appendChild(c)}return n.addEventListener("click",function(n){n.preventDefault(),t.selectIcon(e)}),n},setupVirtualScrollObserver:function(e,t,n){var i=this;this.virtualScrollObservers[n]&&this.virtualScrollObservers[n].disconnect();var c=document.createElement("div");c.className="virtual-scroll-loading",c.style.padding="2rem",c.style.textAlign="center",c.style.color="#6b7280",c.style.fontSize="0.875rem",c.style.fontWeight="500",c.innerHTML="Loading more icons...",e.appendChild(c);var a=document.createElement("div");a.className="virtual-scroll-sentinel",a.style.height="1px",a.style.width="100%",e.appendChild(a);var r=new IntersectionObserver(function(o){o.forEach(function(o){o.isIntersecting&&(i.renderIconBatchBeforeElement(e,t,n,i.virtualScrollBatchSize,c)||(r.disconnect(),a.remove(),c.remove()))})},{root:null,rootMargin:"200px",threshold:.1});r.observe(a),this.virtualScrollObservers[n]=r},renderIconBatchBeforeElement:function(e,t,n,i,c){for(var a=this.virtualScrollRenderedIcons[n]||0,r=Math.min(a+i,t.length),o=a;o<r;o++){var s=t[o],l=this.createIconElement(s);e.insertBefore(l,c)}return this.virtualScrollRenderedIcons[n]=r,r<t.length}};