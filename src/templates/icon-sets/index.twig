{#
 # Icon Sets Listing Page
 #
 # Uses the base plugin's cp-table layout for consistent styling.
 #
 # @link      https://lindemannrock.com
 # @copyright Copyright (c) 2026 LindemannRock
 #}

{% extends 'lindemannrock-base/_layouts/cp-table' %}

{% set plugin = craft.app.plugins.getPlugin('icon-manager') %}
{% set settings = plugin.settings %}

{# Permission checks #}
{% set canCreate = currentUser.can('iconManager:createIconSets') %}
{% set canEdit = currentUser.can('iconManager:editIconSets') %}
{% set canDelete = currentUser.can('iconManager:deleteIconSets') %}

{# Get query parameters #}
{% set search = craft.app.request.getParam('search', '') %}
{% set statusFilter = craft.app.request.getParam('status', 'all') %}
{% set typeFilter = craft.app.request.getParam('type', 'all') %}
{% set sort = craft.app.request.getParam('sort', 'name') %}
{% set dir = craft.app.request.getParam('dir', 'asc') %}

{# Build columns array - conditionally include Optimize column #}
{% set columns = [
    {key: 'name', label: 'Name'|t('icon-manager'), sortable: true},
    {key: 'handle', label: 'Handle'|t('icon-manager')},
    {key: 'type', label: 'Type'|t('icon-manager'), sortable: true, hideable: true},
    {key: 'iconCount', label: 'Icons'|t('icon-manager'), sortable: true, hideable: true},
] %}

{% if settings.enableOptimization %}
    {% set columns = columns|merge([
        {key: 'optimizationIssueCount', label: 'Optimize'|t('icon-manager'), sortable: true, hideable: true},
    ]) %}
{% endif %}

{% set columns = columns|merge([
    {key: 'enabled', label: 'Enabled'|t('icon-manager'), sortable: true},
]) %}

{% set tableConfig = {
    plugin: {
        handle: 'icon-manager',
        name: iconHelper.fullName,
    },
    page: {
        title: 'Icon Sets'|t('icon-manager'),
        subnav: 'icon-sets',
        crumbs: [
            { label: iconHelper.fullName, url: url('icon-manager') },
            { label: 'Icon Sets'|t('icon-manager'), url: url('icon-manager/icon-sets') },
        ],
    },
    filters: [
        {
            type: 'status',
            param: 'status',
            current: statusFilter,
            label: statusFilter == 'all' ? 'All'|t('icon-manager') : statusFilter|capitalize,
            groups: [
                {
                    param: 'status',
                    current: statusFilter,
                    options: [
                        {value: 'all', label: 'All'|t('icon-manager'), status: 'all'},
                        {value: 'enabled', label: 'Enabled'|t('icon-manager'), status: 'green'},
                        {value: 'disabled', label: 'Disabled'|t('icon-manager'), status: 'disabled'},
                    ],
                },
                {
                    header: 'Type'|t('icon-manager'),
                    param: 'type',
                    current: typeFilter,
                    colorSet: 'iconType',
                    options: [
                        {value: 'all', label: 'All Types'|t('icon-manager'), status: 'all'},
                        {value: 'svg-folder', label: 'SVG Folder'|t('icon-manager'), colorKey: 'svg-folder'},
                        {value: 'svg-sprite', label: 'SVG Sprite'|t('icon-manager'), colorKey: 'svg-sprite'},
                        {value: 'font-awesome', label: 'Font Awesome'|t('icon-manager'), colorKey: 'font-awesome'},
                        {value: 'material-icons', label: 'Material Icons'|t('icon-manager'), colorKey: 'material-icons'},
                        {value: 'web-font', label: 'Web Font'|t('icon-manager'), colorKey: 'web-font'},
                    ],
                },
            ],
        },
    ],
    search: {
        placeholder: 'Search icon sets...'|t('icon-manager'),
        value: search,
    },
    sort: {
        field: sort,
        direction: dir,
    },
    table: {
        columns: columns,
        items: iconSets,
        emptyMessage: 'No icon sets found.'|t('icon-manager'),
    },
    pagination: {
        page: page,
        limit: limit,
        totalCount: totalCount,
        itemLabel: {singular: 'icon set'|t('icon-manager'), plural: 'icon sets'|t('icon-manager')},
    },
    checkboxes: canEdit or canDelete,
    rowActions: canEdit or canDelete,
    newButton: canCreate ? {
        url: url('icon-manager/icon-sets/new'),
        label: 'New Icon Set'|t('icon-manager'),
        permission: 'iconManager:createIconSets',
    } : null,
} %}

{% block tableRow %}
    {# Name column #}
    <td data-column="name">
        {% if canEdit %}
            <a class="label-link" href="{{ url('icon-manager/icon-sets/' ~ item.id) }}">
                <span>{{ item.name }}</span>
            </a>
        {% else %}
            <span>{{ item.name }}</span>
        {% endif %}
    </td>

    {# Handle column #}
    <td data-column="handle"><code>{{ item.handle }}</code></td>

    {# Type column #}
    <td data-column="type" class="lr-hideable-column">
        {% include 'lindemannrock-base/_components/badge' with {
            label: item.getTypeLabel(),
            value: item.type,
            colorSet: 'iconType',
        } only %}
    </td>

    {# Icons count column #}
    <td data-column="iconCount" class="lr-hideable-column">{{ item.getIconCount()|number_format }}</td>

    {# Optimize column (conditional) #}
    {% if settings.enableOptimization %}
        <td data-column="optimizationIssueCount" class="lr-hideable-column">
            {% set issueCount = item.getOptimizationIssueCount() %}
            {% if item.type in ['svg-folder', 'folder'] %}
                {% if issueCount > 0 %}
                    <a href="{{ url('icon-manager/icon-sets/' ~ item.id ~ '#optimization') }}"
                       style="text-decoration: none;"
                       title="{{ 'View optimization details'|t('icon-manager') }}">
                        {{ issueCount }}
                    </a>
                {% else %}
                    <span style="color: #10b981;">&#10003;</span>
                {% endif %}
            {% else %}
                <span class="light">â€”</span>
            {% endif %}
        </td>
    {% endif %}

    {# Enabled column #}
    <td data-column="enabled">
        {% if item.enabled %}
            {% include 'lindemannrock-base/_components/badge' with {
                label: 'Enabled'|t('icon-manager'),
                value: 'enabled',
                colorSet: 'status',
            } only %}
        {% else %}
            {% include 'lindemannrock-base/_components/badge' with {
                label: 'Disabled'|t('icon-manager'),
                value: 'disabled',
                colorSet: 'status',
            } only %}
        {% endif %}
    </td>
{% endblock %}

{% block rowActions %}
    {% include 'lindemannrock-base/_components/row-actions' with {
        item: item,
        actions: {
            type: 'menu',
            icon: 'settings',
            title: 'Actions'|t('app'),
            items: [
                {
                    label: 'Edit'|t('app'),
                    url: url('icon-manager/icon-sets/' ~ item.id),
                    permission: 'iconManager:editIconSets',
                },
                {type: 'divider'},
                {
                    label: 'Delete'|t('app'),
                    class: 'error',
                    permission: 'iconManager:deleteIconSets',
                    jsAction: 'delete',
                    data: {name: item.name},
                },
            ],
        },
    } only %}
{% endblock %}

{% block bulkActions %}
    {% if canEdit %}
        <div>
            <button type="button" class="btn menubtn secondary" id="lr-bulk-status-btn" aria-label="{{ 'Set status'|t('app') }}">
                {{ 'Set status'|t('app') }}
            </button>
            <div class="menu">
                <ul>
                    <li><a id="lr-bulk-enable-action">{{ 'Enable'|t('icon-manager') }}</a></li>
                    <li><a id="lr-bulk-disable-action">{{ 'Disable'|t('icon-manager') }}</a></li>
                </ul>
            </div>
        </div>
    {% endif %}
    {% if canDelete %}
        <div>
            <button type="button" class="btn secondary menubtn" data-icon="settings" title="{{ 'Actions'|t('app') }}" id="lr-bulk-actions-btn"></button>
            <div class="menu">
                <ul>
                    <li><a id="lr-bulk-delete-action" class="error">{{ 'Delete...'|t('app') }}</a></li>
                </ul>
            </div>
        </div>
    {% endif %}
{% endblock %}

{% block scripts %}
<script>
(function() {
    const canEdit = {{ canEdit ? 'true' : 'false' }};
    const canDelete = {{ canDelete ? 'true' : 'false' }};

    // Selection state (managed by cp-table layout)
    let selectedIds = new Set();

    // Listen for selection changes from cp-table
    document.addEventListener('lr:selectionChanged', function(e) {
        selectedIds = new Set(e.detail.selectedIds);
    });

    // Initialize bulk action menu buttons
    const bulkStatusBtn = document.getElementById('lr-bulk-status-btn');
    if (bulkStatusBtn && typeof Craft !== 'undefined' && Craft.MenuBtn) {
        new Craft.MenuBtn(bulkStatusBtn);
    }

    const bulkActionsBtn = document.getElementById('lr-bulk-actions-btn');
    if (bulkActionsBtn && typeof Craft !== 'undefined' && Craft.MenuBtn) {
        new Craft.MenuBtn(bulkActionsBtn);
    }

    // Bulk enable
    document.getElementById('lr-bulk-enable-action')?.addEventListener('click', function(e) {
        e.preventDefault();
        const ids = Array.from(selectedIds);
        if (ids.length === 0) return;

        Craft.sendActionRequest('POST', 'icon-manager/icon-sets/bulk-enable', {
            data: { iconSetIds: ids }
        }).then(function(response) {
            if (response.data.success) {
                Craft.cp.displayNotice(`Enabled ${response.data.enabled} icon set${response.data.enabled > 1 ? 's' : ''}`);
                setTimeout(() => window.location.reload(), 1000);
            }
        }).catch(function(error) {
            Craft.cp.displayError('{{ 'Failed to enable icon sets'|t('icon-manager')|e('js') }}');
        });
    });

    // Bulk disable
    document.getElementById('lr-bulk-disable-action')?.addEventListener('click', function(e) {
        e.preventDefault();
        const ids = Array.from(selectedIds);
        if (ids.length === 0) return;

        Craft.sendActionRequest('POST', 'icon-manager/icon-sets/bulk-disable', {
            data: { iconSetIds: ids }
        }).then(function(response) {
            if (response.data.success) {
                Craft.cp.displayNotice(`Disabled ${response.data.disabled} icon set${response.data.disabled > 1 ? 's' : ''}`);
                setTimeout(() => window.location.reload(), 1000);
            }
        }).catch(function(error) {
            Craft.cp.displayError('{{ 'Failed to disable icon sets'|t('icon-manager')|e('js') }}');
        });
    });

    // Bulk delete
    document.getElementById('lr-bulk-delete-action')?.addEventListener('click', function(e) {
        e.preventDefault();
        const ids = Array.from(selectedIds);
        if (ids.length === 0) return;

        if (!confirm(`{{ 'Delete'|t('app')|e('js') }} ${ids.length} {{ 'icon set'|t('icon-manager')|e('js') }}${ids.length > 1 ? 's' : ''}?`)) return;

        Craft.sendActionRequest('POST', 'icon-manager/icon-sets/bulk-delete', {
            data: { iconSetIds: ids }
        }).then(function(response) {
            if (response.data.success) {
                Craft.cp.displayNotice(`Deleted ${response.data.deleted} icon set${response.data.deleted > 1 ? 's' : ''}`);
                setTimeout(() => window.location.reload(), 1000);
            }
        }).catch(function(error) {
            Craft.cp.displayError('{{ 'Failed to delete icon sets'|t('icon-manager')|e('js') }}');
        });
    });

    // Individual delete from row-actions menu
    function attachDeleteListeners() {
        document.querySelectorAll('[data-action="delete"]').forEach(deleteLink => {
            if (deleteLink._hasListener) return;
            deleteLink._hasListener = true;

            deleteLink.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                const row = this.closest('tr');
                const id = this.dataset.id;
                const name = this.dataset.name;

                if (!confirm(`{{ 'Delete'|t('app')|e('js') }} "${name}"?`)) return;

                Craft.sendActionRequest('POST', 'icon-manager/icon-sets/delete', {
                    data: { iconSetId: id }
                }).then(function(response) {
                    if (response.data.success) {
                        row.remove();
                        Craft.cp.displayNotice('{{ 'Icon set deleted'|t('icon-manager')|e('js') }}');

                        // Check if table is now empty
                        if (document.querySelectorAll('tbody tr').length === 0) {
                            window.location.reload();
                        }
                    }
                }).catch(function(error) {
                    Craft.cp.displayError('{{ 'Failed to delete icon set'|t('icon-manager')|e('js') }}');
                });
            });
        });
    }
    attachDeleteListeners();
})();
</script>
{% endblock %}
