{% extends 'lindemannrock-base/_layouts/cp-utilities' %}

{# Permission checks #}
{% set canViewIconSets = currentUser.can('iconManager:viewIconSets') or currentUser.can('iconManager:createIconSets') or currentUser.can('iconManager:editIconSets') or currentUser.can('iconManager:deleteIconSets') or currentUser.can('iconManager:manageOptimization') %}
{% set canEditIconSets = currentUser.can('iconManager:editIconSets') %}
{% set canManageOptimization = currentUser.can('iconManager:manageOptimization') %}
{% set canEditSettings = currentUser.can('iconManager:editSettings') %}

{% set hasNavigation = canViewIconSets or canEditSettings %}
{% set hasIconManagement = canEditIconSets %}
{% set hasAnyQuickAction = hasNavigation or hasIconManagement %}

{% set utilitiesConfig = {
    plugin: {
        handle: 'icon-manager',
        name: iconHelper.fullName,
    },
    page: {
        title: 'Overview'|t('icon-manager'),
        description: 'Monitor icon set performance, manage cache, and view system status for your icon collections.'|t('icon-manager'),
    },
} %}

{% block overview %}
    {# Icon Sets Card #}
    {% include 'lindemannrock-base/_components/cards/unified-card' with {
        title: 'Icon Sets'|t('icon-manager'),
        color: lrPaletteColor('emerald').color,
        value: iconSetCount,
        valueColor: lrPaletteColor('emerald').color,
        badge: 'Active'|t('icon-manager'),
        badgeColor: lrPaletteColor('emerald').color,
        description: 'Total icon sets configured'|t('icon-manager'),
        subBoxes: [
            {value: totalIcons, label: 'Total Icons'|t('icon-manager')},
        ],
    } only %}

    {# Cache Status Card #}
    {% if cacheEnabled %}
        {% if storageMethod == 'redis' %}
            {% include 'lindemannrock-base/_components/cards/unified-card' with {
                title: 'Cache Status'|t('icon-manager') ~ ' (Redis)',
                color: lrPaletteColor('emerald').color,
                value: 'Active'|t('icon-manager'),
            } only %}
        {% else %}
            {% set totalCached = cacheStats['svg-folder'] + cacheStats['svg-sprite'] + cacheStats['material-icons'] + cacheStats['font-awesome'] + cacheStats['web-font'] %}
            {% include 'lindemannrock-base/_components/cards/unified-card' with {
                title: 'Cache Status'|t('icon-manager') ~ ' (File)',
                color: lrPaletteColor('emerald').color,
                value: totalCached,
                description: 'Total cached entries'|t('icon-manager'),
                subBoxes: [
                    {value: cacheStats['svg-folder'], label: 'SVG Folder'|t('icon-manager')},
                    {value: cacheStats['svg-sprite'], label: 'Sprite'|t('icon-manager')},
                    {value: cacheStats['material-icons'] + cacheStats['font-awesome'] + cacheStats['web-font'], label: 'Fonts'|t('icon-manager')},
                ],
            } only %}
        {% endif %}
    {% else %}
        {% include 'lindemannrock-base/_components/cards/unified-card' with {
            title: 'Cache Status'|t('icon-manager'),
            color: lrPaletteColor('gray').color,
            value: 'Disabled'|t('icon-manager'),
            valueColor: lrPaletteColor('gray').color,
            description: 'Cache is disabled'|t('icon-manager'),
        } only %}
    {% endif %}

    {# Cache Settings Card #}
    {% include 'lindemannrock-base/_components/cards/unified-card' with {
        title: 'Cache Settings'|t('icon-manager'),
        color: cacheEnabled ? lrPaletteColor('sky').color : lrPaletteColor('gray').color,
        value: cacheEnabled ? cacheDuration : '—',
        valueColor: cacheEnabled ? null : lrPaletteColor('gray').color,
        description: cacheEnabled ? 'Cache duration'|t('icon-manager') : 'No cache configured'|t('icon-manager'),
        subBoxes: [
            {value: cacheEnabled ? '✓' : '✗', label: cacheEnabled ? 'Enabled'|t('icon-manager') : 'Disabled'|t('icon-manager')},
        ],
    } only %}
{% endblock %}

{% block quickActions %}
    {% if hasAnyQuickAction %}
        {# Navigation Section #}
        {% if hasNavigation %}
            {% set navButtons = [] %}
            {% if canViewIconSets %}
                {% set navButtons = navButtons|merge([{type: 'link', label: 'Manage Icon Sets'|t('icon-manager'), url: url('icon-manager')}]) %}
            {% endif %}
            {% if canEditSettings %}
                {% set navButtons = navButtons|merge([{type: 'link', label: 'View Settings'|t('icon-manager'), url: url('icon-manager/settings')}]) %}
            {% endif %}

            {% include 'lindemannrock-base/_layouts/cp-utilities/_action-section' with {
                title: 'Navigation'|t('icon-manager'),
                description: 'Access main plugin sections'|t('icon-manager'),
                buttons: navButtons,
            } only %}
        {% endif %}

        {# Icon Management Section - Custom due to form #}
        {% if hasIconManagement %}
            {% if hasNavigation %}<hr style="margin: 24px 0; border: none; border-top: 1px solid #e5e7eb;">{% endif %}

            <div>
                <h3 style="margin-bottom: 8px;">{{ "Icon Management"|t('icon-manager') }}</h3>
                <p class="light" style="margin-bottom: 16px;">{{ "Refresh all icon sets to fetch new icons from their sources (CDNs, APIs, directories)."|t('icon-manager') }}</p>

                <form method="post" accept-charset="UTF-8">
                    {{ csrfInput() }}
                    {{ actionInput('icon-manager/utilities/refresh-all-icons') }}
                    {{ redirectInput('utilities/clear-icon-cache') }}

                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button type="submit" class="btn submit">
                            {{ "Refresh All Icons"|t('icon-manager') }}
                        </button>
                    </div>
                </form>
            </div>
        {% endif %}
    {% endif %}
{% endblock %}

{% block additionalContent %}
{# SVG Quality Section #}
{% if canManageOptimization %}
<div style="margin-bottom: 40px;" id="svg-quality">
    <h2>{{ 'SVG Quality'|t('icon-manager') }}</h2>

    <div class="pane">
        {% set optimizationEnabled = craft.iconManager.settings.enableOptimization %}

        {% if not optimizationEnabled %}
            <div style="padding: 20px; background: #fef3c7; border: 1px solid #fbbf24; border-radius: 8px; text-align: center;">
                <p style="font-size: 16px; font-weight: 600; color: #78350f; margin: 0 0 8px 0;">{{ "SVG Optimization Disabled"|t('icon-manager') }}</p>
                <p style="font-size: 14px; color: #92400e; margin: 0;">
                    {{ "Enable optimization in"|t('icon-manager') }} <a href="{{ url('icon-manager/settings') }}" style="font-weight: 600; text-decoration: underline;">{{ "Settings"|t('icon-manager') }}</a> {{ "or via config file"|t('icon-manager') }}
                </p>
            </div>
        {% else %}
        <div>
            <h3 style="margin-bottom: 8px;">{{ "Scan for Issues"|t('icon-manager') }}</h3>
            <p class="light" style="margin-bottom: 16px;">{{ "Scan SVG files for optimization opportunities (clip-paths, masks, filters, large files)."|t('icon-manager') }}</p>

            <form method="post" accept-charset="UTF-8">
                {{ csrfInput() }}
                {{ actionInput('icon-manager/utilities/scan-svgs') }}
                {{ redirectInput('utilities/clear-icon-cache#svg-quality') }}

                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button type="submit" class="btn submit">
                        {{ "Scan SVG Quality"|t('icon-manager') }}
                    </button>
                </div>
            </form>
        </div>
        {% endif %}

        {% set svgScanResults = craft.app.session.get('svgScanResults') %}
        {% if svgScanResults %}
            {# Clear the session after reading #}
            {% do craft.app.session.remove('svgScanResults') %}
            {% set settings = craft.iconManager.settings %}

            <div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid #e5e7eb;">
            {% if svgScanResults|length > 0 %}
                {% set totalIssues = 0 %}
                {% set totalIconSets = svgScanResults|length %}
                {% for result in svgScanResults %}
                    {% set totalIssues = totalIssues + result.issues.clipPaths + result.issues.masks + result.issues.filters + result.issues.comments + result.issues.inlineStyles + result.issues.largeFiles %}
                {% endfor %}

                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h3 style="margin: 0;">{{ "Scan Results"|t('icon-manager') }}</h3>
                    <div style="padding: 6px 12px; background: #fef3c7; border: 1px solid #fbbf24; border-radius: 4px; font-size: 13px; font-weight: 600; color: #92400e;">
                        {{ "Found {count} issues across {sets} icon sets"|t('icon-manager', {count: totalIssues, sets: totalIconSets}) }}
                    </div>
                </div>

                <div style="overflow-x: auto; margin-top: 12px;">
                <table class="data fullwidth" style="font-size: 13px; border-collapse: collapse; border: 1px solid #e5e7eb;">
                    <thead>
                        <tr style="background: #f9fafb;">
                            <th style="padding: 10px 12px; text-align: left; border: 1px solid #e5e7eb; width: 140px; max-width: 140px;">{{ "Icon Set"|t('icon-manager') }}</th>
                            <th style="padding: 10px 8px; text-align: center; border: 1px solid #e5e7eb; width: 90px;">{{ "Icons"|t('icon-manager') }}</th>
                            <th style="padding: 10px 8px; text-align: center; border: 1px solid #e5e7eb; width: 110px;">{{ "Size"|t('icon-manager') }}</th>
                            {% if settings.scanClipPaths %}
                            <th class="thin" style="padding: 10px 8px; text-align: center; border: 1px solid #e5e7eb;">
                                {{ "Clip"|t('icon-manager') }}
                                <span class="info" style="margin-left: 4px;">{{ 'Empty or unused clip-paths'|t('icon-manager') }}</span>
                            </th>
                            {% endif %}
                            {% if settings.scanMasks %}
                            <th class="thin" style="padding: 10px 8px; text-align: center; border: 1px solid #e5e7eb;">
                                {{ "Mask"|t('icon-manager') }}
                                <span class="info" style="margin-left: 4px;">{{ 'Empty or unused masks'|t('icon-manager') }}</span>
                            </th>
                            {% endif %}
                            {% if settings.scanFilters %}
                            <th class="thin" style="padding: 10px 8px; text-align: center; border: 1px solid #e5e7eb;">
                                {{ "Filter"|t('icon-manager') }}
                                <span class="info" style="margin-left: 4px;">{{ 'Complex effects that can slow down rendering'|t('icon-manager') }}</span>
                            </th>
                            {% endif %}
                            {% if settings.scanComments %}
                            <th class="thin" style="padding: 10px 8px; text-align: center; border: 1px solid #e5e7eb;">
                                {{ "Comment"|t('icon-manager') }}
                                <span class="info" style="margin-left: 4px;">{{ 'Unnecessary metadata'|t('icon-manager') }}</span>
                            </th>
                            {% endif %}
                            {% if settings.scanInlineStyles %}
                            <th class="thin" style="padding: 10px 8px; text-align: center; border: 1px solid #e5e7eb;">
                                {{ "Style"|t('icon-manager') }}
                                <span class="info" style="margin-left: 4px;">{{ 'Harder to override with CSS'|t('icon-manager') }}</span>
                            </th>
                            {% endif %}
                            {% if settings.scanLargeFiles %}
                            <th class="thin" style="padding: 10px 8px; text-align: center; border: 1px solid #e5e7eb;">
                                {{ "Large"|t('icon-manager') }}
                                <span class="info" style="margin-left: 4px;">{{ 'Files over 10KB'|t('icon-manager') }}</span>
                            </th>
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for result in svgScanResults %}
                            <tr>
                                <td style="padding: 8px 12px; border: 1px solid #e5e7eb;">
                                    <a href="{{ url('icon-manager/icon-sets/' ~ result.iconSetId ~ '#optimization') }}">
                                        {{ result.iconSetName }}
                                    </a>
                                </td>
                                <td class="thin" style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">{{ result.totalIcons }}</td>
                                <td class="thin" style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">{{ craft.iconManager.svgOptimizer.formatFileSize(result.totalSize) }}</td>
                                {% if settings.scanClipPaths %}
                                <td class="thin" style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">
                                    {% if result.issues.clipPaths > 0 %}
                                        <span style="color: {{ lrPaletteColor('red').color }}; font-weight: 600;">{{ result.issues.clipPaths }}</span>
                                    {% else %}
                                        <span style="color: {{ lrPaletteColor('gray').color }};">—</span>
                                    {% endif %}
                                </td>
                                {% endif %}
                                {% if settings.scanMasks %}
                                <td class="thin" style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">
                                    {% if result.issues.masks > 0 %}
                                        <span style="color: {{ lrPaletteColor('red').color }}; font-weight: 600;">{{ result.issues.masks }}</span>
                                    {% else %}
                                        <span style="color: {{ lrPaletteColor('gray').color }};">—</span>
                                    {% endif %}
                                </td>
                                {% endif %}
                                {% if settings.scanFilters %}
                                <td class="thin" style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">
                                    {% if result.issues.filters > 0 %}
                                        <span style="color: {{ lrPaletteColor('red').color }}; font-weight: 600;">{{ result.issues.filters }}</span>
                                    {% else %}
                                        <span style="color: {{ lrPaletteColor('gray').color }};">—</span>
                                    {% endif %}
                                </td>
                                {% endif %}
                                {% if settings.scanComments %}
                                <td class="thin" style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">
                                    {% if result.issues.comments > 0 %}
                                        <span style="color: {{ lrPaletteColor('red').color }}; font-weight: 600;">{{ result.issues.comments }}</span>
                                    {% else %}
                                        <span style="color: {{ lrPaletteColor('gray').color }};">—</span>
                                    {% endif %}
                                </td>
                                {% endif %}
                                {% if settings.scanInlineStyles %}
                                <td class="thin" style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">
                                    {% if result.issues.inlineStyles > 0 %}
                                        <span style="color: {{ lrPaletteColor('red').color }}; font-weight: 600;">{{ result.issues.inlineStyles }}</span>
                                    {% else %}
                                        <span style="color: {{ lrPaletteColor('gray').color }};">—</span>
                                    {% endif %}
                                </td>
                                {% endif %}
                                {% if settings.scanLargeFiles %}
                                <td class="thin" style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">
                                    {% if result.issues.largeFiles > 0 %}
                                        <span style="color: {{ lrPaletteColor('red').color }}; font-weight: 600;">{{ result.issues.largeFiles }}</span>
                                    {% else %}
                                        <span style="color: {{ lrPaletteColor('gray').color }};">—</span>
                                    {% endif %}
                                </td>
                                {% endif %}
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
                </div>
            {% else %}
                <div class="pane" style="padding: 40px; text-align: center;">
                    <p style="color: {{ lrPaletteColor('emerald').color }}; font-size: 48px; margin: 0;">✓</p>
                    <p style="font-size: 18px; font-weight: 600; margin: 10px 0;">{{ "No SVG icon sets found"|t('icon-manager') }}</p>
                    <p class="light">{{ "Create an SVG Folder icon set to scan for quality issues."|t('icon-manager') }}</p>
                </div>
            {% endif %}
            </div>
        {% endif %}
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
{% js %}
// Smooth scroll to SVG Quality section if hash is present
if (window.location.hash === '#svg-quality') {
    setTimeout(function() {
        document.getElementById('svg-quality').scrollIntoView({
            behavior: 'smooth',
            block: 'start'
        });
    }, 100);
}
{% endjs %}
{% endblock %}

{% block pluginCredit %}
{% include 'icon-manager/_components/plugin-credit.twig' %}
{% endblock %}
