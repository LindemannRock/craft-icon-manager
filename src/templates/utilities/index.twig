{% import "_includes/forms" as forms %}

<div style="margin-bottom: 32px;">
    <h2>{{ "{pluginName} Overview"|t('icon-manager', {pluginName: iconHelper.fullName}) }}</h2>
    <p class="light">{{ "Monitor icon set performance, manage cache, and view system status for your icon collections."|t('icon-manager') }}</p>
</div>

<div style="margin-bottom: 40px;">
    <h2>{{ "System Overview"|t('icon-manager') }}</h2>

    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; align-items: stretch;">
        <!-- Icon Sets Status Card -->
        <div class="pane" style="padding: 24px; margin-block: 0; background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); display: flex; flex-direction: column; height: 100%; grid-column: span 1;">
            <!-- Header -->
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                <div style="width: 12px; height: 12px; border-radius: 50%; background: #059669;"></div>
                <h4 style="margin: 0; color: #374151; font-size: 15px; font-weight: 600;">{{ "Icon Sets"|t('icon-manager') }}</h4>
            </div>

            <!-- Main Content -->
            <div style="flex: 1; display: flex; flex-direction: column;">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                    <div style="font-size: 28px; font-weight: 700; color: #059669; line-height: 1;">
                        {{ iconSetCount }}
                    </div>
                    <div style="padding: 3px 10px; border-radius: 16px; font-size: 11px; font-weight: 700; text-transform: uppercase; color: white; background: #059669;">
                        {{ 'Active'|t('icon-manager') }}
                    </div>
                </div>
                <div style="font-size: 14px; color: #4b5563; margin-bottom: 12px;">
                    {{ "Total icon sets configured"|t('icon-manager') }}
                </div>

                <!-- Bottom Boxes -->
                <div style="margin-top: auto;">
                    <div style="display: grid; grid-template-columns: 1fr; gap: 8px;">
                        <div style="padding: 12px; background: rgba(255,255,255,0.9); border: 1px solid #e5e7eb; border-radius: 8px; text-align: center; min-height: 60px; display: flex; flex-direction: column; justify-content: center;">
                            <div style="font-size: 16px; font-weight: 600; color: #374151; margin-bottom: 4px;">{{ totalIcons|number_format }}</div>
                            <div style="font-size: 11px; color: #4b5563; text-transform: uppercase;">{{ 'Total Icons'|t('icon-manager') }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cache Status Card -->
        <div class="pane" style="padding: 24px; margin-block: 0; background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); display: flex; flex-direction: column; height: 100%; grid-column: span 2;">
            <!-- Header -->
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                <div style="width: 12px; height: 12px; border-radius: 50%; background: {% if cacheEnabled %}#22c55e{% else %}#6b7280{% endif %};"></div>
                <h4 style="margin: 0; color: #374151; font-size: 15px; font-weight: 600;">
                    {{ "Cache Status"|t('icon-manager') }}{% if cacheEnabled %} ({{ storageMethod == 'redis' ? 'Redis' : 'File' }}){% endif %}
                </h4>
            </div>

            <!-- Main Content -->
            <div style="flex: 1; display: flex; flex-direction: column;">
                {% if cacheEnabled %}
                    {% if storageMethod == 'redis' %}
                        <div style="font-size: 28px; font-weight: 700; color: #0f172a; line-height: 1;">
                            {{ "Active"|t('icon-manager') }}
                        </div>
                    {% else %}
                        <div style="display: flex; align-items: baseline; gap: 12px; margin-bottom: 12px;">
                            <div style="font-size: 28px; font-weight: 700; color: #0f172a; line-height: 1;">
                                {{ (cacheStats['svg-folder'] + cacheStats['svg-sprite'] + cacheStats['material-icons'] + cacheStats['font-awesome'] + cacheStats['web-font'])|number_format }}
                            </div>
                        </div>
                        <div style="font-size: 14px; color: #4b5563; margin-bottom: 12px;">
                            {{ "Total cached entries"|t('icon-manager') }}
                        </div>
                    {% endif %}
                {% else %}
                    <div style="display: flex; align-items: baseline; gap: 12px; margin-bottom: 12px;">
                        <div style="font-size: 28px; font-weight: 700; color: #0f172a; line-height: 1;">
                            <span style="font-size: 18px; color: #6b7280;">{{ 'Disabled'|t('icon-manager') }}</span>
                        </div>
                    </div>
                    <div style="font-size: 14px; color: #4b5563; margin-bottom: 12px;">
                        {{ "Cache is disabled"|t('icon-manager') }}
                    </div>
                {% endif %}

                <!-- Bottom Boxes -->
                {% if cacheEnabled and storageMethod != 'redis' %}
                <div style="margin-top: auto;">
                    <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px;">
                        <div style="padding: 12px; background: rgba(255,255,255,0.9); border: 1px solid #e5e7eb; border-radius: 8px; text-align: center; min-height: 60px; display: flex; flex-direction: column; justify-content: center;">
                            <div style="font-size: 16px; font-weight: 600; color: #374151; margin-bottom: 4px;">{{ cacheStats['svg-folder']|number_format }}</div>
                            <div style="font-size: 11px; color: #4b5563; text-transform: uppercase;">{{ 'SVG Folder'|t('icon-manager') }}</div>
                        </div>
                        <div style="padding: 12px; background: rgba(255,255,255,0.9); border: 1px solid #e5e7eb; border-radius: 8px; text-align: center; min-height: 60px; display: flex; flex-direction: column; justify-content: center;">
                            <div style="font-size: 16px; font-weight: 600; color: #374151; margin-bottom: 4px;">{{ cacheStats['svg-sprite']|number_format }}</div>
                            <div style="font-size: 11px; color: #4b5563; text-transform: uppercase;">{{ 'SVG Sprite'|t('icon-manager') }}</div>
                        </div>
                        <div style="padding: 12px; background: rgba(255,255,255,0.9); border: 1px solid #e5e7eb; border-radius: 8px; text-align: center; min-height: 60px; display: flex; flex-direction: column; justify-content: center;">
                            <div style="font-size: 16px; font-weight: 600; color: #374151; margin-bottom: 4px;">{{ cacheStats['material-icons']|number_format }}</div>
                            <div style="font-size: 11px; color: #4b5563; text-transform: uppercase;">{{ 'MI'|t('icon-manager') }}</div>
                        </div>
                        <div style="padding: 12px; background: rgba(255,255,255,0.9); border: 1px solid #e5e7eb; border-radius: 8px; text-align: center; min-height: 60px; display: flex; flex-direction: column; justify-content: center;">
                            <div style="font-size: 16px; font-weight: 600; color: #374151; margin-bottom: 4px;">{{ cacheStats['font-awesome']|number_format }}</div>
                            <div style="font-size: 11px; color: #4b5563; text-transform: uppercase;">{{ 'FA'|t('icon-manager') }}</div>
                        </div>
                        <div style="padding: 12px; background: rgba(255,255,255,0.9); border: 1px solid #e5e7eb; border-radius: 8px; text-align: center; min-height: 60px; display: flex; flex-direction: column; justify-content: center;">
                            <div style="font-size: 16px; font-weight: 600; color: #374151; margin-bottom: 4px;">{{ cacheStats['web-font']|number_format }}</div>
                            <div style="font-size: 11px; color: #4b5563; text-transform: uppercase;">{{ 'Web Font'|t('icon-manager') }}</div>
                        </div>
                    </div>
                </div>
                {% elseif not cacheEnabled %}
                <div style="margin-top: auto;">
                    <div style="padding: 12px; background: rgba(255,255,255,0.9); border: 1px solid #e5e7eb; border-radius: 8px; text-align: center;">
                        <p style="font-size: 12px; color: #6b7280; margin: 0;">
                            {{ "Enable caching in"|t('icon-manager') }} <a href="{{ url('icon-manager/settings') }}">{{ "Settings"|t('icon-manager') }}</a>
                        </p>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Cache Settings Card -->
        <div class="pane" style="padding: 24px; margin-block: 0; background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); display: flex; flex-direction: column; height: 100%; grid-column: span 1;">
            <!-- Header -->
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                <div style="width: 12px; height: 12px; border-radius: 50%; background: {% if cacheEnabled %}#0ea5e9{% else %}#6b7280{% endif %};"></div>
                <h4 style="margin: 0; color: #374151; font-size: 15px; font-weight: 600;">{{ "Cache Settings"|t('icon-manager') }}</h4>
            </div>

            <!-- Main Content -->
            <div style="flex: 1; display: flex; flex-direction: column;">
                <div style="display: flex; align-items: baseline; gap: 12px; margin-bottom: 12px;">
                    <div style="font-size: 28px; font-weight: 700; color: #0f172a; line-height: 1;">
                        {% if cacheEnabled %}
                            {{ cacheDuration }}
                        {% else %}
                            <span style="font-size: 18px; color: #6b7280;">—</span>
                        {% endif %}
                    </div>
                </div>
                <div style="font-size: 14px; color: #4b5563; margin-bottom: 12px;">
                    {% if cacheEnabled %}
                        {{ "Cache duration"|t('icon-manager') }}
                    {% else %}
                        {{ "No cache configured"|t('icon-manager') }}
                    {% endif %}
                </div>

                <!-- Bottom Boxes -->
                <div style="margin-top: auto;">
                    <div style="padding: 12px; background: rgba(255,255,255,0.9); border: 1px solid #e5e7eb; border-radius: 8px; text-align: center; min-height: 60px; display: flex; flex-direction: column; justify-content: center;">
                        <div style="font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 4px;">
                            {% if cacheEnabled %}
                                <span style="color: #22c55e;">✓</span> {{ 'Enabled'|t('icon-manager') }}
                            {% else %}
                                <span style="color: #6b7280;">✗</span> {{ 'Disabled'|t('icon-manager') }}
                            {% endif %}
                        </div>
                        <div style="font-size: 11px; color: #4b5563; text-transform: uppercase;">{{ 'Cache Status'|t('icon-manager') }}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div style="margin-bottom: 40px;">
    <h2>{{ 'Quick Actions'|t('icon-manager') }}</h2>

    <div class="pane">
        <div style="margin-bottom: 24px;">
            <h3 style="margin-bottom: 8px;">{{ "Navigation"|t('icon-manager') }}</h3>
            <p class="light" style="margin-bottom: 16px;">{{ "Access main plugin sections"|t('icon-manager') }}</p>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <a href="{{ url('icon-manager') }}" class="btn">
                    {{ "Manage Icon Sets"|t('icon-manager') }}
                </a>
                <a href="{{ url('icon-manager/settings') }}" class="btn">
                    {{ "View Settings"|t('icon-manager') }}
                </a>
            </div>
        </div>

        <hr style="margin: 24px 0; border: none; border-top: 1px solid #e5e7eb;">

        <div>
            <h3 style="margin-bottom: 8px;">{{ "Icon Management"|t('icon-manager') }}</h3>
            <p class="light" style="margin-bottom: 16px;">{{ "Refresh all icon sets to fetch new icons from their sources (CDNs, APIs, directories)."|t('icon-manager') }}</p>

            <form method="post" accept-charset="UTF-8">
                {{ csrfInput() }}
                {{ actionInput('icon-manager/utilities/refresh-all-icons') }}
                {{ redirectInput('utilities/clear-icon-cache') }}

                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button type="submit" class="btn submit">
                        {{ "Refresh All Icons"|t('icon-manager') }}
                    </button>
                </div>
            </form>
        </div>

        {# HIDDEN: Rebuild Icon Cache button is redundant with Refresh All Icons
           The rebuild button only clears cache and relies on page load to rebuild (creates 6 cache files),
           while Refresh All Icons does a proper full scan and rebuild (creates 7 cache files including
           Material Icons definitions cache). This inconsistency (6 vs 7) is confusing for users.
           "Refresh All Icons" is the better option and should be the primary action. #}
        {#
        <hr style="margin: 24px 0; border: none; border-top: 1px solid #e5e7eb;">

        <div>
            <h3 style="margin-bottom: 8px;">{{ "Cache Management"|t('icon-manager') }}</h3>
            <p class="light" style="margin-bottom: 16px;">{{ "Rebuild icon cache to reload data from cache. Useful after clearing cache or troubleshooting."|t('icon-manager') }}</p>

            <form method="post" accept-charset="UTF-8">
                {{ csrfInput() }}
                {{ actionInput('icon-manager/cache/clear') }}
                {{ redirectInput('utilities/clear-icon-cache') }}

                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button type="submit" class="btn">
                        {{ "Rebuild Icon Cache"|t('icon-manager') }}
                        {% if cacheEnabled %}
                            ({{ (cacheStats['svg-folder'] + cacheStats['svg-sprite'] + cacheStats['material-icons'] + cacheStats['font-awesome'] + cacheStats['web-font']) }})
                        {% endif %}
                    </button>
                </div>
            </form>
        </div>
        #}
    </div>
</div>

<!-- SVG Quality -->
<div style="margin-bottom: 40px;" id="svg-quality">
    <h2>{{ 'SVG Quality'|t('icon-manager') }}</h2>

    <div class="pane">
        {% set optimizationEnabled = craft.iconManager.settings.enableOptimization %}

        {% if not optimizationEnabled %}
            <div style="padding: 20px; background: #fef3c7; border: 1px solid #fbbf24; border-radius: 8px; text-align: center;">
                <p style="font-size: 16px; font-weight: 600; color: #78350f; margin: 0 0 8px 0;">{{ "SVG Optimization Disabled"|t('icon-manager') }}</p>
                <p style="font-size: 14px; color: #92400e; margin: 0;">
                    {{ "Enable optimization in"|t('icon-manager') }} <a href="{{ url('icon-manager/settings') }}" style="font-weight: 600; text-decoration: underline;">{{ "Settings"|t('icon-manager') }}</a> {{ "or via config file"|t('icon-manager') }}
                </p>
            </div>
        {% else %}
        <div>
            <h3 style="margin-bottom: 8px;">{{ "Scan for Issues"|t('icon-manager') }}</h3>
            <p class="light" style="margin-bottom: 16px;">{{ "Scan SVG files for optimization opportunities (clip-paths, masks, filters, large files)."|t('icon-manager') }}</p>

            <form method="post" accept-charset="UTF-8">
                {{ csrfInput() }}
                {{ actionInput('icon-manager/utilities/scan-svgs') }}
                {{ redirectInput('utilities/clear-icon-cache#svg-quality') }}

                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button type="submit" class="btn submit">
                        {{ "Scan SVG Quality"|t('icon-manager') }}
                    </button>
                </div>
            </form>
        </div>
        {% endif %}

        {% set svgScanResults = craft.app.session.get('svgScanResults') %}
        {% if svgScanResults %}
            {# Clear the session after reading #}
            {% do craft.app.session.remove('svgScanResults') %}
            {% set settings = craft.iconManager.settings %}

            <div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid #e5e7eb;">
            {% if svgScanResults|length > 0 %}
                {% set totalIssues = 0 %}
                {% set totalIconSets = svgScanResults|length %}
                {% for result in svgScanResults %}
                    {% set totalIssues = totalIssues + result.issues.clipPaths + result.issues.masks + result.issues.filters + result.issues.comments + result.issues.inlineStyles + result.issues.largeFiles %}
                {% endfor %}

                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h3 style="margin: 0;">{{ "Scan Results"|t('icon-manager') }}</h3>
                    <div style="padding: 6px 12px; background: #fef3c7; border: 1px solid #fbbf24; border-radius: 4px; font-size: 13px; font-weight: 600; color: #92400e;">
                        {{ "Found {count} issues across {sets} icon sets"|t('icon-manager', {count: totalIssues, sets: totalIconSets}) }}
                    </div>
                </div>

                <div style="overflow-x: auto; margin-top: 12px;">
                <table class="data fullwidth" style="font-size: 13px; border-collapse: collapse; border: 1px solid #e5e7eb;">
                    <thead>
                        <tr style="background: #f9fafb;">
                            <th style="padding: 10px 12px; text-align: left; border: 1px solid #e5e7eb; width: 140px; max-width: 140px;">{{ "Icon Set"|t('icon-manager') }}</th>
                            <th style="padding: 10px 8px; text-align: center; border: 1px solid #e5e7eb; width: 90px;">{{ "Icons"|t('icon-manager') }}</th>
                            <th style="padding: 10px 8px; text-align: center; border: 1px solid #e5e7eb; width: 110px;">{{ "Size"|t('icon-manager') }}</th>
                            {% if settings.scanClipPaths %}
                            <th class="thin" style="padding: 10px 8px; text-align: center; border: 1px solid #e5e7eb;">
                                {{ "Clip"|t('icon-manager') }}
                                <span class="info" style="margin-left: 4px;">{{ 'Empty or unused clip-paths'|t('icon-manager') }}</span>
                            </th>
                            {% endif %}
                            {% if settings.scanMasks %}
                            <th class="thin" style="padding: 10px 8px; text-align: center; border: 1px solid #e5e7eb;">
                                {{ "Mask"|t('icon-manager') }}
                                <span class="info" style="margin-left: 4px;">{{ 'Empty or unused masks'|t('icon-manager') }}</span>
                            </th>
                            {% endif %}
                            {% if settings.scanFilters %}
                            <th class="thin" style="padding: 10px 8px; text-align: center; border: 1px solid #e5e7eb;">
                                {{ "Filter"|t('icon-manager') }}
                                <span class="info" style="margin-left: 4px;">{{ 'Complex effects that can slow down rendering'|t('icon-manager') }}</span>
                            </th>
                            {% endif %}
                            {% if settings.scanComments %}
                            <th class="thin" style="padding: 10px 8px; text-align: center; border: 1px solid #e5e7eb;">
                                {{ "Comment"|t('icon-manager') }}
                                <span class="info" style="margin-left: 4px;">{{ 'Unnecessary metadata'|t('icon-manager') }}</span>
                            </th>
                            {% endif %}
                            {% if settings.scanInlineStyles %}
                            <th class="thin" style="padding: 10px 8px; text-align: center; border: 1px solid #e5e7eb;">
                                {{ "Style"|t('icon-manager') }}
                                <span class="info" style="margin-left: 4px;">{{ 'Harder to override with CSS'|t('icon-manager') }}</span>
                            </th>
                            {% endif %}
                            {% if settings.scanLargeFiles %}
                            <th class="thin" style="padding: 10px 8px; text-align: center; border: 1px solid #e5e7eb;">
                                {{ "Large"|t('icon-manager') }}
                                <span class="info" style="margin-left: 4px;">{{ 'Files over 10KB'|t('icon-manager') }}</span>
                            </th>
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for result in svgScanResults %}
                            <tr>
                                <td style="padding: 8px 12px; border: 1px solid #e5e7eb;">
                                    <a href="{{ url('icon-manager/icon-sets/' ~ result.iconSetId ~ '#optimization') }}">
                                        {{ result.iconSetName }}
                                    </a>
                                </td>
                                <td class="thin" style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">{{ result.totalIcons }}</td>
                                <td class="thin" style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">{{ craft.iconManager.svgOptimizer.formatFileSize(result.totalSize) }}</td>
                                {% if settings.scanClipPaths %}
                                <td class="thin" style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">
                                    {% if result.issues.clipPaths > 0 %}
                                        <span style="color: #dc2626; font-weight: 600;">{{ result.issues.clipPaths }}</span>
                                    {% else %}
                                        <span style="color: #9ca3af;">—</span>
                                    {% endif %}
                                </td>
                                {% endif %}
                                {% if settings.scanMasks %}
                                <td class="thin" style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">
                                    {% if result.issues.masks > 0 %}
                                        <span style="color: #dc2626; font-weight: 600;">{{ result.issues.masks }}</span>
                                    {% else %}
                                        <span style="color: #9ca3af;">—</span>
                                    {% endif %}
                                </td>
                                {% endif %}
                                {% if settings.scanFilters %}
                                <td class="thin" style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">
                                    {% if result.issues.filters > 0 %}
                                        <span style="color: #dc2626; font-weight: 600;">{{ result.issues.filters }}</span>
                                    {% else %}
                                        <span style="color: #9ca3af;">—</span>
                                    {% endif %}
                                </td>
                                {% endif %}
                                {% if settings.scanComments %}
                                <td class="thin" style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">
                                    {% if result.issues.comments > 0 %}
                                        <span style="color: #dc2626; font-weight: 600;">{{ result.issues.comments }}</span>
                                    {% else %}
                                        <span style="color: #9ca3af;">—</span>
                                    {% endif %}
                                </td>
                                {% endif %}
                                {% if settings.scanInlineStyles %}
                                <td class="thin" style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">
                                    {% if result.issues.inlineStyles > 0 %}
                                        <span style="color: #dc2626; font-weight: 600;">{{ result.issues.inlineStyles }}</span>
                                    {% else %}
                                        <span style="color: #9ca3af;">—</span>
                                    {% endif %}
                                </td>
                                {% endif %}
                                {% if settings.scanLargeFiles %}
                                <td class="thin" style="padding: 8px; text-align: center; border: 1px solid #e5e7eb;">
                                    {% if result.issues.largeFiles > 0 %}
                                        <span style="color: #dc2626; font-weight: 600;">{{ result.issues.largeFiles }}</span>
                                    {% else %}
                                        <span style="color: #9ca3af;">—</span>
                                    {% endif %}
                                </td>
                                {% endif %}
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
                </div>
            {% else %}
                <div class="pane" style="padding: 40px; text-align: center;">
                    <p style="color: #10b981; font-size: 48px; margin: 0;">✓</p>
                    <p style="font-size: 18px; font-weight: 600; margin: 10px 0;">{{ "No SVG icon sets found"|t('icon-manager') }}</p>
                    <p class="light">{{ "Create an SVG Folder icon set to scan for quality issues."|t('icon-manager') }}</p>
                </div>
            {% endif %}
            </div>
        {% endif %}
    </div>
</div>

{% js %}
    // Smooth scroll to SVG Quality section if hash is present
    if (window.location.hash === '#svg-quality') {
        setTimeout(function() {
            document.getElementById('svg-quality').scrollIntoView({
                behavior: 'smooth',
                block: 'start'
            });
        }, 100);
    }
{% endjs %}

{% include 'icon-manager/_components/plugin-credit.twig' %}
