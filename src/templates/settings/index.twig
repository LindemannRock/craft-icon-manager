{#
 # Icon Manager Settings
 #
 # @link      https://lindemannrock.com
 # @copyright Copyright (c) 2025 LindemannRock
 #}

{% extends "_layouts/cp" %}
{% import "_includes/forms" as forms %}

{% set title = 'Settings'|t('icon-manager') %}
{% set selectedSubnavItem = 'settings' %}
{% set fullPageForm = true %}

{% set plugin = craft.app.plugins.getPlugin('icon-manager') %}
{% set crumbs = [
    { label: plugin.settings.pluginName, url: url('icon-manager') },
    { label: 'Settings'|t('icon-manager'), url: url('icon-manager/settings') }
] %}

{% block content %}
    {{ actionInput('icon-manager/settings/save') }}
    {{ redirectInput('icon-manager/settings') }}

    {{ forms.textField({
        label: 'Plugin name'|t('icon-manager'),
        instructions: 'The public-facing name of the plugin'|t('icon-manager'),
        id: 'pluginName',
        name: 'settings[pluginName]',
        value: settings.pluginName ?? 'Icon Manager',
        placeholder: 'Icon Manager',
        warning: settings.isOverriddenByConfig('pluginName') ? 'This is being overridden by the `pluginName` setting in the `config/icon-manager.php` file.'|t('icon-manager'),
        disabled: settings.isOverriddenByConfig('pluginName'),
        fieldAttributes: {
            style: 'margin-top: 0;'
        }
    }) }}

    <hr>

    <h2>{{ 'General Settings'|t('icon-manager') }}</h2>

    {{ forms.autosuggestField({
        label: 'Icons Path'|t('icon-manager'),
        instructions: 'Provide the full path to your icon files. Also supports aliases.'|t('icon-manager'),
        id: 'iconSetsPath',
        name: 'settings[iconSetsPath]',
        value: settings.iconSetsPath,
        suggestEnvVars: true,
        suggestAliases: true,
        required: true,
        warning: settings.isOverriddenByConfig('iconSetsPath') ? 'This is being overridden by the `iconSetsPath` setting in the `config/icon-manager.php` file.'|t('icon-manager') : 'All icon sets will look for icons relative to this path.',
        disabled: settings.isOverriddenByConfig('iconSetsPath')
    }) }}

    <hr>

    <h2>{{ 'Cache Settings'|t('icon-manager') }}</h2>

    {{ forms.lightswitchField({
        label: 'Enable Cache'|t('icon-manager'),
        instructions: 'Whether to cache icon data for better performance.'|t('icon-manager'),
        id: 'enableCache',
        name: 'settings[enableCache]',
        on: settings.enableCache,
        warning: settings.isOverriddenByConfig('enableCache') ? 'This is being overridden by the `enableCache` setting in the `config/icon-manager.php` file.'|t('icon-manager'),
        disabled: settings.isOverriddenByConfig('enableCache')
    }) }}

    {{ forms.textField({
        label: 'Cache Duration'|t('icon-manager'),
        instructions: 'How long to cache icon data, in seconds.'|t('icon-manager'),
        id: 'cacheDuration',
        name: 'settings[cacheDuration]',
        value: settings.cacheDuration,
        type: 'number',
        min: 0,
        warning: settings.isOverriddenByConfig('cacheDuration') ? 'This is being overridden by the `cacheDuration` setting in the `config/icon-manager.php` file.'|t('icon-manager'),
        disabled: settings.isOverriddenByConfig('cacheDuration')
    }) }}

    <hr>

    <h2>{{ 'Icon Types'|t('icon-manager') }}</h2>

    <p>{{ 'Choose which icon set types are available in the system.'|t('icon-manager') }}</p>

    {{ forms.lightswitchField({
        label: 'SVG Folder'|t('icon-manager'),
        instructions: 'Enable SVG files from folders'|t('icon-manager'),
        id: 'enabledIconTypes-svg-folder',
        name: 'settings[enabledIconTypes][svg-folder]',
        on: settings.enabledIconTypes['svg-folder'] ?? true,
        warning: settings.isIconTypeOverridden('svg-folder') ? 'This is being overridden by the `enabledIconTypes[\'svg-folder\']` setting in the `config/icon-manager.php` file.'|t('icon-manager'),
        disabled: settings.isIconTypeOverridden('svg-folder')
    }) }}

    {{ forms.lightswitchField({
        label: 'SVG Sprite'|t('icon-manager'),
        instructions: 'Enable SVG sprite files'|t('icon-manager'),
        id: 'enabledIconTypes-svg-sprite',
        name: 'settings[enabledIconTypes][svg-sprite]',
        on: settings.enabledIconTypes['svg-sprite'] ?? true,
        warning: settings.isIconTypeOverridden('svg-sprite') ? 'This is being overridden by the `enabledIconTypes[\'svg-sprite\']` setting in the `config/icon-manager.php` file.'|t('icon-manager'),
        disabled: settings.isIconTypeOverridden('svg-sprite')
    }) }}

    {{ forms.lightswitchField({
        label: 'Font Awesome'|t('icon-manager'),
        instructions: 'Enable Font Awesome icons'|t('icon-manager'),
        id: 'enabledIconTypes-font-awesome',
        name: 'settings[enabledIconTypes][font-awesome]',
        on: settings.enabledIconTypes['font-awesome'] ?? true,
        warning: settings.isIconTypeOverridden('font-awesome') ? 'This is being overridden by the `enabledIconTypes[\'font-awesome\']` setting in the `config/icon-manager.php` file.'|t('icon-manager'),
        disabled: settings.isIconTypeOverridden('font-awesome')
    }) }}

    {{ forms.lightswitchField({
        label: 'Material Icons'|t('icon-manager'),
        instructions: 'Enable Material Design icons'|t('icon-manager'),
        id: 'enabledIconTypes-material-icons',
        name: 'settings[enabledIconTypes][material-icons]',
        on: settings.enabledIconTypes['material-icons'] ?? false,
        warning: settings.isIconTypeOverridden('material-icons') ? 'This is being overridden by the `enabledIconTypes[\'material-icons\']` setting in the `config/icon-manager.php` file.'|t('icon-manager'),
        disabled: settings.isIconTypeOverridden('material-icons')
    }) }}

    {{ forms.lightswitchField({
        label: 'Web Font'|t('icon-manager'),
        instructions: 'Enable custom icon fonts (TTF, WOFF, WOFF2, OTF)'|t('icon-manager'),
        id: 'enabledIconTypes-web-font',
        name: 'settings[enabledIconTypes][web-font]',
        on: settings.enabledIconTypes['web-font'] ?? false,
        warning: settings.isIconTypeOverridden('web-font') ? 'This is being overridden by the `enabledIconTypes[\'web-font\']` setting in the `config/icon-manager.php` file.'|t('icon-manager'),
        disabled: settings.isIconTypeOverridden('web-font')
    }) }}

    <hr>

    <h2>{{ 'SVG Optimization'|t('icon-manager') }}</h2>

    {{ forms.lightswitchField({
        label: 'Enable Optimization'|t('icon-manager'),
        instructions: 'Enable SVG optimization features (scanning and applying optimizations)'|t('icon-manager'),
        id: 'enableOptimization',
        name: 'settings[enableOptimization]',
        on: settings.enableOptimization,
        warning: settings.isOverriddenByConfig('enableOptimization') ? 'This is being overridden by the `enableOptimization` setting in the `config/icon-manager.php` file.'|t('icon-manager'),
        disabled: settings.isOverriddenByConfig('enableOptimization')
    }) }}

    <div id="optimization-settings" class="{% if not settings.enableOptimization %}hidden{% endif %}">
    {{ forms.lightswitchField({
        label: 'Enable Automatic Backups'|t('icon-manager'),
        instructions: 'Automatically create backups before applying optimizations'|t('icon-manager'),
        id: 'enableOptimizationBackup',
        name: 'settings[enableOptimizationBackup]',
        on: settings.enableOptimizationBackup,
        warning: settings.isOverriddenByConfig('enableOptimizationBackup') ? 'This is being overridden by the `enableOptimizationBackup` setting in the `config/icon-manager.php` file.'|t('icon-manager'),
        disabled: settings.isOverriddenByConfig('enableOptimizationBackup')
    }) }}

    <h3 style="margin-top: 24px; margin-bottom: 12px;">{{ 'Scan Controls'|t('icon-manager') }}</h3>
    <p class="light" style="margin-bottom: 16px;">{{ 'Choose which issues to detect during SVG optimization scans'|t('icon-manager') }}</p>

    {{ forms.lightswitchField({
        label: 'Scan Clip-Paths'|t('icon-manager'),
        instructions: 'Detect empty or unused clip-path definitions'|t('icon-manager'),
        id: 'scanClipPaths',
        name: 'settings[scanClipPaths]',
        on: settings.scanClipPaths,
        warning: settings.isOverriddenByConfig('scanClipPaths') ? 'This is being overridden by the `scanClipPaths` setting in the `config/icon-manager.php` file.'|t('icon-manager'),
        disabled: settings.isOverriddenByConfig('scanClipPaths')
    }) }}

    {{ forms.lightswitchField({
        label: 'Scan Masks'|t('icon-manager'),
        instructions: 'Detect empty or unused mask definitions'|t('icon-manager'),
        id: 'scanMasks',
        name: 'settings[scanMasks]',
        on: settings.scanMasks,
        warning: settings.isOverriddenByConfig('scanMasks') ? 'This is being overridden by the `scanMasks` setting in the `config/icon-manager.php` file.'|t('icon-manager'),
        disabled: settings.isOverriddenByConfig('scanMasks')
    }) }}

    {{ forms.lightswitchField({
        label: 'Scan Filters'|t('icon-manager'),
        instructions: 'Detect filter effects that may slow rendering'|t('icon-manager'),
        id: 'scanFilters',
        name: 'settings[scanFilters]',
        on: settings.scanFilters,
        warning: settings.isOverriddenByConfig('scanFilters') ? 'This is being overridden by the `scanFilters` setting in the `config/icon-manager.php` file.'|t('icon-manager'),
        disabled: settings.isOverriddenByConfig('scanFilters')
    }) }}

    {{ forms.lightswitchField({
        label: 'Scan Comments'|t('icon-manager'),
        instructions: 'Detect comments in SVG files (excludes legal comments like <!--! ... -->)'|t('icon-manager'),
        id: 'scanComments',
        name: 'settings[scanComments]',
        on: settings.scanComments,
        warning: settings.isOverriddenByConfig('scanComments') ? 'This is being overridden by the `scanComments` setting in the `config/icon-manager.php` file.'|t('icon-manager'),
        disabled: settings.isOverriddenByConfig('scanComments')
    }) }}

    {{ forms.lightswitchField({
        label: 'Scan Inline Styles'|t('icon-manager'),
        instructions: 'Detect convertible inline styles (excludes CSS-only properties like isolation, mix-blend-mode)'|t('icon-manager'),
        id: 'scanInlineStyles',
        name: 'settings[scanInlineStyles]',
        on: settings.scanInlineStyles,
        warning: settings.isOverriddenByConfig('scanInlineStyles') ? 'This is being overridden by the `scanInlineStyles` setting in the `config/icon-manager.php` file.'|t('icon-manager'),
        disabled: settings.isOverriddenByConfig('scanInlineStyles')
    }) }}

    {{ forms.lightswitchField({
        label: 'Scan Large Files'|t('icon-manager'),
        instructions: 'Detect files over 10KB (warning only, may be normal for complex icons)'|t('icon-manager'),
        id: 'scanLargeFiles',
        name: 'settings[scanLargeFiles]',
        on: settings.scanLargeFiles,
        warning: settings.isOverriddenByConfig('scanLargeFiles') ? 'This is being overridden by the `scanLargeFiles` setting in the `config/icon-manager.php` file.'|t('icon-manager'),
        disabled: settings.isOverriddenByConfig('scanLargeFiles')
    }) }}

    {{ forms.lightswitchField({
        label: 'Scan Width/Height (Critical)'|t('icon-manager'),
        instructions: 'Detect width/height attributes without viewBox (responsive SVG issue)'|t('icon-manager'),
        id: 'scanWidthHeight',
        name: 'settings[scanWidthHeight]',
        on: settings.scanWidthHeight,
        warning: settings.isOverriddenByConfig('scanWidthHeight') ? 'This is being overridden by the `scanWidthHeight` setting in the `config/icon-manager.php` file.'|t('icon-manager'),
        disabled: settings.isOverriddenByConfig('scanWidthHeight')
    }) }}

    {{ forms.lightswitchField({
        label: 'Scan Width/Height with ViewBox'|t('icon-manager'),
        instructions: 'Detect width/height even when viewBox exists (optional optimization for viewBox-only SVGs)'|t('icon-manager'),
        id: 'scanWidthHeightWithViewBox',
        name: 'settings[scanWidthHeightWithViewBox]',
        on: settings.scanWidthHeightWithViewBox,
        warning: settings.isOverriddenByConfig('scanWidthHeightWithViewBox') ? 'This is being overridden by the `scanWidthHeightWithViewBox` setting in the `config/icon-manager.php` file.'|t('icon-manager'),
        disabled: settings.isOverriddenByConfig('scanWidthHeightWithViewBox')
    }) }}
    </div>{# end optimization-settings #}

    <hr>

    <h2>{{ 'Logging Settings'|t('icon-manager') }}</h2>

    {% set logOptions = [
        {value: 'error', label: 'Error (Critical errors only)'|t('icon-manager')},
        {value: 'warning', label: 'Warning (Errors and warnings)'|t('icon-manager')},
        {value: 'info', label: 'Info (General information)'|t('icon-manager')},
    ] %}

    {% if craft.app.config.general.devMode %}
        {% set logOptions = logOptions|merge([
            {value: 'debug', label: 'Debug (Detailed debugging)'|t('icon-manager')}
        ]) %}
    {% endif %}


    {{ forms.selectField({
        label: 'Log Level'|t('icon-manager'),
        instructions: craft.app.config.general.devMode ?
            'Choose what types of messages to log. Higher levels include all lower levels (Error < Warning < Info < Debug)'|t('icon-manager') :
            'Choose what types of messages to log. Debug level requires devMode to be enabled.'|t('icon-manager'),
        id: 'logLevel',
        name: 'settings[logLevel]',
        value: settings.logLevel,
        options: logOptions,
        warning: settings.isOverriddenByConfig('logLevel') ? 'This is being overridden by the `logLevel` setting in the `config/icon-manager.php` file.'|t('icon-manager'),
        disabled: settings.isOverriddenByConfig('logLevel')
    }) }}

    {% include 'icon-manager/_components/plugin-credit.twig' %}
{% endblock %}

{% js %}
// Toggle optimization settings visibility based on enableOptimization
$('#enableOptimization').on('change', function() {
    var isEnabled = $(this).siblings('.lightswitch').hasClass('on');
    var $optimizationSettings = $('#optimization-settings');

    if (isEnabled) {
        $optimizationSettings.removeClass('hidden');
    } else {
        $optimizationSettings.addClass('hidden');
    }
});
{% endjs %}
