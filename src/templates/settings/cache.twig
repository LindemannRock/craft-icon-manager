{% extends "icon-manager/_layouts/settings" %}
{% set title = "Cache Settings"|t('icon-manager') %}
{% set fullPageForm = true %}
{% set selectedSettingsItem = 'cache' %}

{% set plugin = craft.app.plugins.getPlugin('icon-manager') %}
{% set crumbs = [
    {
        label: iconHelper.fullName|t('icon-manager'),
        url: url('icon-manager'),
    },
    {
        label: 'Settings'|t('icon-manager'),
        url: url('icon-manager/settings'),
    },
    {
        label: 'Cache'|t('icon-manager'),
        url: url('icon-manager/settings/cache'),
    },
] %}

{% import "_includes/forms" as forms %}

{% block content %}
    <form method="post" accept-charset="UTF-8">
        {{ actionInput('icon-manager/settings/save') }}
        {{ csrfInput() }}
        {{ redirectInput('icon-manager/settings/cache') }}
        {{ hiddenInput('section', 'cache') }}

        <h2 style="margin-top: 0px;">{{ 'Cache Storage Settings'|t('icon-manager') }}</h2>

        {{ forms.selectField({
            label: 'Cache Storage Method'|t('icon-manager'),
            instructions: 'How to store cache data. Use Redis/Database for load-balanced or multi-server environments.'|t('icon-manager'),
            id: 'cacheStorageMethod',
            name: 'settings[cacheStorageMethod]',
            value: settings.cacheStorageMethod ?? 'file',
            options: [
                { value: 'file', label: 'File System (default, single server)'|t('icon-manager') },
                { value: 'redis', label: 'Redis/Database (load-balanced, multi-server, cloud hosting)'|t('icon-manager') },
            ],
            disabled: settings.isOverriddenByConfig('cacheStorageMethod'),
            warning: settings.isOverriddenByConfig('cacheStorageMethod') ?
                "This is being overridden by the <code>cacheStorageMethod</code> setting in <code>config/icon-manager.php</code>."|t('icon-manager')|raw : null,
        }) }}

        {% set craftUsesRedis = craft.app.cache is defined and craft.app.cache.className is defined and craft.app.cache.className == 'yii\\redis\\Cache' %}

        <div id="cache-location-file" class="{{ (settings.cacheStorageMethod ?? 'file') == 'redis' ? 'hidden' }}">
            {% include 'icon-manager/_components/info-box' with {
                message: '<strong>Cache Location:</strong> <code>' ~ iconHelper.cacheBasePath ~ '</code>',
                type: 'info'
            } %}
        </div>

        <div id="cache-location-redis" class="{{ (settings.cacheStorageMethod ?? 'file') == 'file' ? 'hidden' }}">
            {% if craftUsesRedis %}
                {% include 'icon-manager/_components/info-box' with {
                    type: 'success',
                    message: '<strong>Cache Location:</strong> Using Craft\'s configured Redis cache from <code>config/app.php</code>'
                } %}
            {% else %}
                {% include 'icon-manager/_components/info-box' with {
                    type: 'warning',
                    message: '<strong>Redis Not Configured:</strong> To use Redis caching, install <code>yiisoft/yii2-redis</code> and configure it in <code>config/app.php</code>. <a href="https://craftcms.com/docs/5.x/reference/config/app.html#cache" target="_blank" rel="noopener">Learn more</a>'
                } %}
            {% endif %}
        </div>

        <hr>

        <h2>{{ 'Icon Caching'|t('icon-manager') }}</h2>

        {{ forms.lightswitchField({
            label: 'Enable Cache'|t('icon-manager'),
            instructions: 'Cache icon data for better performance'|t('icon-manager'),
            id: 'enableCache',
            name: 'settings[enableCache]',
            on: settings.enableCache,
            toggle: 'cache-settings',
            warning: settings.isOverriddenByConfig('enableCache') ? 'This is being overridden by the <code>enableCache</code> setting in the <code>config/icon-manager.php</code> file.'|t('icon-manager')|raw : null,
            disabled: settings.isOverriddenByConfig('enableCache')
        }) }}

        <div id="cache-settings" class="{{ not settings.enableCache ? 'hidden' }}">
            {{ forms.textField({
                label: 'Cache Duration'|t('icon-manager'),
                instructions: ('Cache duration in seconds. Current: <strong id="cacheDuration-human"></strong>')|raw,
                id: 'cacheDuration',
                name: 'settings[cacheDuration]',
                value: settings.cacheDuration ?? 86400,
                type: 'number',
                min: 60,
                max: 604800,
                tip: 'Min: 60 (1 minute), Max: 604800 (7 days)'|t('icon-manager'),
                warning: settings.isOverriddenByConfig('cacheDuration') ? 'This is being overridden by the <code>cacheDuration</code> setting in the <code>config/icon-manager.php</code> file.'|t('icon-manager')|raw : null,
                disabled: settings.isOverriddenByConfig('cacheDuration')
            }) }}
        </div>

        <div class="buttons">
            <button type="submit" class="btn submit">{{ "Save Settings"|t('icon-manager') }}</button>
        </div>
    </form>

    {% include 'icon-manager/_components/plugin-credit.twig' %}
{% endblock %}

{% js %}
// Toggle cache location info boxes based on storage method selection
$('#cacheStorageMethod').on('change', function() {
    const value = $(this).val();
    if (value === 'redis') {
        $('#cache-location-file').addClass('hidden');
        $('#cache-location-redis').removeClass('hidden');
    } else {
        $('#cache-location-redis').addClass('hidden');
        $('#cache-location-file').removeClass('hidden');
    }
});

// Convert seconds to human-readable duration
function secondsToHuman(seconds) {
    seconds = parseInt(seconds) || 0;
    if (seconds < 60) {
        return seconds + ' second' + (seconds !== 1 ? 's' : '');
    } else if (seconds < 3600) {
        const mins = Math.round(seconds / 60 * 10) / 10;
        return mins + ' minute' + (mins !== 1 ? 's' : '');
    } else if (seconds < 86400) {
        const hours = Math.round(seconds / 3600 * 10) / 10;
        return hours + ' hour' + (hours !== 1 ? 's' : '');
    } else {
        const days = Math.round(seconds / 86400 * 10) / 10;
        return days + ' day' + (days !== 1 ? 's' : '');
    }
}

// Update human-readable duration on input change
$('#cacheDuration').on('input', function() {
    $('#cacheDuration-human').text(secondsToHuman($(this).val()));
});

// Initialize on page load
$('#cacheDuration-human').text(secondsToHuman($('#cacheDuration').val()));
{% endjs %}
